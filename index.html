<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zootropo Interactivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        canvas {
            max-width: 90vw;
            max-height: 70vh;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container">
        <div class="bg-white rounded-xl shadow-lg p-8 max-w-lg w-full flex flex-col items-center text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">Zootropo Interactivo</h1>
            <p class="text-gray-600 mb-6">
                Sube una imagen circular con tu animación y presiona "Girar" para ver la magia del zootropo.
            </p>

            <!-- Contenedor para la entrada de archivo y número de fotogramas -->
            <div class="mb-6 w-full flex flex-col items-center">
                <label class="block mb-2 text-sm font-medium text-gray-700">
                    Selecciona tu disco de zootropo:
                </label>
                <input type="file" id="image-upload" accept="image/*" class="w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-blue-50 file:text-blue-700
                    hover:file:bg-blue-100 cursor-pointer" />
                
                <label for="frame-count" class="block mt-4 text-sm font-medium text-gray-700">
                    Número de fotogramas en el disco:
                </label>
                <input type="number" id="frame-count" value="12" min="1" class="mt-1 block w-24 rounded-md border-gray-300 shadow-sm text-center focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
            </div>

            <!-- Contenedor del canvas y mensaje -->
            <div class="w-full flex flex-col justify-center items-center mb-6">
                <canvas id="zootrope-canvas" class="rounded-full shadow-md"></canvas>
                <p id="message" class="text-sm mt-4 text-gray-600"></p>
            </div>

            <!-- Controles de dirección y animación -->
            <div class="flex flex-wrap justify-center space-x-2 md:space-x-4 mb-4">
                <button id="spin-clockwise" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-full shadow-md hover:bg-blue-700 transition duration-300 mb-2">
                    Girar Horario
                </button>
                <button id="spin-counter-clockwise" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-full shadow-md hover:bg-blue-700 transition duration-300 mb-2">
                    Girar Antihorario
                </button>
                <button id="stop-btn" class="bg-red-500 text-white font-semibold py-2 px-6 rounded-full shadow-md hover:bg-red-600 transition duration-300 mb-2">
                    Detener
                </button>
            </div>

            <!-- Controles de velocidad y guardado -->
            <div class="flex flex-wrap justify-center space-x-2 md:space-x-4">
                <button id="increase-speed-btn" class="bg-green-500 text-white font-semibold py-2 px-6 rounded-full shadow-md hover:bg-green-600 transition duration-300 mb-2">
                    Aumentar Velocidad
                </button>
                <button id="decrease-speed-btn" class="bg-yellow-500 text-white font-semibold py-2 px-6 rounded-full shadow-md hover:bg-yellow-600 transition duration-300 mb-2">
                    Disminuir Velocidad
                </button>
                <button id="save-gif-btn" class="bg-purple-600 text-white font-semibold py-2 px-6 rounded-full shadow-md hover:bg-purple-700 transition duration-300 mb-2">
                    Grabar Animación
                </button>
            </div>
            
            <!-- Contador de velocidad -->
            <div class="mt-4 text-center">
                <p class="text-gray-700 font-medium">Velocidad: <span id="speed-counter" class="font-bold">1.0s</span></p>
                <p class="text-xs text-gray-500 mt-1">(Tiempo entre fotogramas)</p>
            </div>
        </div>
    </div>

    <script>
        // Obtener referencias a los elementos del DOM
        const imageUpload = document.getElementById('image-upload');
        const frameCountInput = document.getElementById('frame-count');
        const zootropeCanvas = document.getElementById('zootrope-canvas');
        const spinClockwiseBtn = document.getElementById('spin-clockwise');
        const spinCounterClockwiseBtn = document.getElementById('spin-counter-clockwise');
        const stopBtn = document.getElementById('stop-btn');
        const increaseSpeedBtn = document.getElementById('increase-speed-btn');
        const decreaseSpeedBtn = document.getElementById('decrease-speed-btn');
        const saveGifBtn = document.getElementById('save-gif-btn');
        const speedCounter = document.getElementById('speed-counter');
        const messageDisplay = document.getElementById('message');

        const ctx = zootropeCanvas.getContext('2d');
        let zootropeImage = new Image();
        let animationInterval;
        let currentSpeed = 100; // Velocidad inicial en milisegundos
        let currentRotation = 0; // Rotación actual en grados
        let rotationDirection = 1; // 1 para horario, -1 para antihorario
        let frames = parseInt(frameCountInput.value);
        let rotationPerFrame = 360 / frames;

        // Establecer el tamaño del canvas
        const setCanvasSize = () => {
            const size = Math.min(window.innerWidth * 0.9, window.innerHeight * 0.7, 500);
            zootropeCanvas.width = size;
            zootropeCanvas.height = size;
            ctx.clearRect(0, 0, size, size);
            ctx.fillStyle = '#e2e8f0';
            ctx.fillRect(0, 0, size, size);
        };
        setCanvasSize();

        // Cargar imagen de ejemplo inicial
        const initialImage = new Image();
        initialImage.onload = () => {
            ctx.drawImage(initialImage, 0, 0, zootropeCanvas.width, zootropeCanvas.height);
        };
        initialImage.src = 'https://placehold.co/400x400/e2e8f0/64748b?text=Subir+Imagen';

        // Manejar el evento de cambio en la entrada de archivo
        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    zootropeImage.onload = () => {
                        // Establecer el tamaño del canvas basado en la imagen cargada
                        zootropeCanvas.width = zootropeImage.naturalWidth;
                        zootropeCanvas.height = zootropeImage.naturalHeight;
                        stopAnimation();
                        drawFrame(0);
                    };
                    zootropeImage.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Manejar el cambio en el número de fotogramas
        frameCountInput.addEventListener('change', () => {
            const newFrames = parseInt(frameCountInput.value);
            if (newFrames > 0) {
                frames = newFrames;
                rotationPerFrame = 360 / frames;
                stopAnimation();
                drawFrame(0);
            }
        });

        // Función para dibujar un fotograma en el canvas
        const drawFrame = (rotation) => {
            ctx.save();
            ctx.clearRect(0, 0, zootropeCanvas.width, zootropeCanvas.height);
            ctx.translate(zootropeCanvas.width / 2, zootropeCanvas.height / 2);
            ctx.rotate(rotation * Math.PI / 180);
            ctx.drawImage(zootropeImage, -zootropeCanvas.width / 2, -zootropeCanvas.height / 2, zootropeCanvas.width, zootropeCanvas.height);
            ctx.restore();
        };

        // Función para iniciar la animación de giro
        const startAnimation = () => {
            stopAnimation(); // Detiene cualquier animación en curso
            animationInterval = setInterval(() => {
                currentRotation += rotationPerFrame * rotationDirection;
                drawFrame(currentRotation);
            }, currentSpeed);
        };

        // Función para detener la animación
        const stopAnimation = () => {
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
            }
        };

        // Función para actualizar la velocidad de la animación
        const updateSpeed = () => {
            stopAnimation();
            startAnimation();
            speedCounter.textContent = `${(currentSpeed / 1000).toFixed(2)}s`;
        };

        // Manejadores de eventos de los botones
        spinClockwiseBtn.addEventListener('click', () => {
            rotationDirection = 1;
            startAnimation();
        });
        spinCounterClockwiseBtn.addEventListener('click', () => {
            rotationDirection = -1;
            startAnimation();
        });
        stopBtn.addEventListener('click', stopAnimation);
        increaseSpeedBtn.addEventListener('click', () => {
            if (currentSpeed > 20) {
                currentSpeed -= 10;
                updateSpeed();
            }
        });
        decreaseSpeedBtn.addEventListener('click', () => {
            if (currentSpeed < 1000) {
                currentSpeed += 10;
                updateSpeed();
            }
        });

        // Guardar la animación como un GIF
        saveGifBtn.addEventListener('click', async () => {
            if (!zootropeImage.src || zootropeImage.src.includes('placehold.co')) {
                messageDisplay.textContent = 'Por favor, sube una imagen primero.';
                return;
            }
            
            stopAnimation();
            messageDisplay.textContent = 'Preparando grabadora... Por favor, espera.';

            try {
                // Obtener el script del worker como un objeto Blob para evitar problemas de CORS
                const workerUrl = 'https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.worker.js';
                const workerResponse = await fetch(workerUrl);
                const workerBlob = await workerResponse.blob();
                const workerScriptUrl = URL.createObjectURL(workerBlob);

                messageDisplay.textContent = 'Generando GIF... Esto puede tardar un momento.';

                const gif = new GIF({
                    workers: 2,
                    quality: 10,
                    workerScript: workerScriptUrl,
                    width: zootropeCanvas.width,
                    height: zootropeCanvas.height,
                });

                // Captura los 200 fotogramas para una animación fluida
                const totalFramesToCapture = 200;
                const rotationStep = 360 / totalFramesToCapture;

                for (let i = 0; i < totalFramesToCapture; i++) {
                    drawFrame(i * rotationStep);
                    gif.addFrame(ctx, { delay: currentSpeed });
                }

                // Renderiza el GIF
                gif.on('finished', (blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'zootropo_animado.gif';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    messageDisplay.textContent = '¡GIF guardado con éxito!';
                });

                gif.on('error', (err) => {
                    messageDisplay.textContent = `Error al generar el GIF: ${err}`;
                    console.error('GIF.js Error:', err);
                });

                gif.render();

            } catch (error) {
                messageDisplay.textContent = `Error al cargar los recursos: ${error.message}`;
                console.error('Fetch Error:', error);
            }
        });

    </script>
</body>
</html>

